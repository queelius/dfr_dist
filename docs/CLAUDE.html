<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>CLAUDE.md • dfr.dist</title><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="CLAUDE.md"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">dfr.dist</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="articles/failure_rate.html">Dynamic Failure Rate Distributions</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/queelius/dfr_dist/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>CLAUDE.md</h1>
      <small class="dont-index">Source: <a href="https://github.com/queelius/dfr_dist/blob/HEAD/CLAUDE.md" class="external-link"><code>CLAUDE.md</code></a></small>
    </div>

<div id="claudemd" class="section level1">

<p>This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.</p>
<div class="section level2">
<h2 id="project-overview">Project Overview<a class="anchor" aria-label="anchor" href="#project-overview"></a></h2>
<p><code>dfr.dist</code> is an R package for working with dynamic failure rate (DFR) distributions in survival analysis. The package parameterizes distributions using flexible failure rate (hazard) functions that can depend on time and any set of predictors/covariates.</p>
</div>
<div class="section level2">
<h2 id="development-commands">Development Commands<a class="anchor" aria-label="anchor" href="#development-commands"></a></h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/document.html" class="external-link">document</a></span><span class="op">(</span><span class="op">)</span>      <span class="co"># Update NAMESPACE and .Rd files from roxygen2</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/build.html" class="external-link">build</a></span><span class="op">(</span><span class="op">)</span>         <span class="co"># Build package tarball</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/check.html" class="external-link">check</a></span><span class="op">(</span><span class="op">)</span>         <span class="co"># Run R CMD check</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/install.html" class="external-link">install</a></span><span class="op">(</span><span class="op">)</span>       <span class="co"># Install locally</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/test.html" class="external-link">test</a></span><span class="op">(</span><span class="op">)</span>          <span class="co"># Run tests</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/build_vignettes.html" class="external-link">build_vignettes</a></span><span class="op">(</span><span class="op">)</span>    <span class="co"># Build vignettes</span></span>
<span><span class="fu">pkgdown</span><span class="fu">::</span><span class="fu"><a href="https://pkgdown.r-lib.org/reference/build_site.html" class="external-link">build_site</a></span><span class="op">(</span><span class="op">)</span>          <span class="co"># Build package website</span></span></code></pre></div>
<p>Always run <code><a href="https://devtools.r-lib.org/reference/document.html" class="external-link">devtools::document()</a></code> after modifying roxygen2 comments. NAMESPACE is auto-generated - never edit manually.</p>
</div>
<div class="section level2">
<h2 id="core-architecture">Core Architecture<a class="anchor" aria-label="anchor" href="#core-architecture"></a></h2>
<div class="section level3">
<h3 id="the-dfr_dist-object">The <code>dfr_dist</code> Object<a class="anchor" aria-label="anchor" href="#the-dfr_dist-object"></a></h3>
<p>The central abstraction in <code>R/dfr_dist.R</code>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/dfr_dist.html">dfr_dist</a></span><span class="op">(</span><span class="va">rate</span>, par <span class="op">=</span> <span class="cn">NULL</span>, eps <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span></code></pre></div>
<ul><li>
<code>rate</code>: Function computing hazard rate h(t, par, …)</li>
<li>
<code>par</code>: Distribution parameters (can be NULL if unknown)</li>
<li>
<code>eps</code>: Epsilon for numerical integration/sampling</li>
</ul><p>Inherits from <code>"univariate_dist"</code> and <code>"dist"</code> classes, implementing the <code>algebraic.dist</code> interface.</p>
</div>
<div class="section level3">
<h3 id="key-constraints-on-hazard-functions">Key Constraints on Hazard Functions<a class="anchor" aria-label="anchor" href="#key-constraints-on-hazard-functions"></a></h3>
<p>All failure rate functions must satisfy: 1. <strong>Non-negativity</strong>: h(t, …) ≥ 0 for all t 2. <strong>Infinite cumulative hazard</strong>: lim(t→∞) H(t) = ∞, where H(t) = ∫₀ᵗ h(u) du</p>
<p>These are not enforced in code but are required for mathematical correctness.</p>
</div>
<div class="section level3">
<h3 id="closure-returning-pattern">Closure-Returning Pattern<a class="anchor" aria-label="anchor" href="#closure-returning-pattern"></a></h3>
<p>All distribution methods follow a two-step pattern - understanding this is critical for working with the package:</p>
<ol style="list-style-type: decimal"><li>Method is called on <code>dfr_dist</code> object, returning a closure</li>
<li>Closure accepts time <code>t</code>, parameters <code>par</code>, and additional args <code>...</code>
</li>
</ol><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create distribution</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/dfr_dist.html">dfr_dist</a></span><span class="op">(</span>rate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">t</span>, <span class="va">par</span>, <span class="va">...</span><span class="op">)</span> <span class="va">par</span>, par <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get hazard function (returns closure)</span></span>
<span><span class="va">h</span> <span class="op">&lt;-</span> <span class="fu">hazard</span><span class="op">(</span><span class="va">d</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Use the closure</span></span>
<span><span class="fu">h</span><span class="op">(</span>t <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>              <span class="co"># Uses default par = 1</span></span>
<span><span class="fu">h</span><span class="op">(</span>t <span class="op">=</span> <span class="fl">5</span>, par <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>     <span class="co"># Overrides with par = 2</span></span></code></pre></div>
<p>This enables flexible parameter handling and late binding of parameters (useful for MLE).</p>
</div>
<div class="section level3">
<h3 id="distribution-methods">Distribution Methods<a class="anchor" aria-label="anchor" href="#distribution-methods"></a></h3>
<table class="table"><thead><tr class="header"><th>Method</th>
<th>Returns</th>
<th>Formula</th>
</tr></thead><tbody><tr class="odd"><td><code>hazard()</code></td>
<td>h(t, par, …)</td>
<td>Direct rate function</td>
</tr><tr class="even"><td><code><a href="reference/cum_haz.html">cum_haz()</a></code></td>
<td>H(t, par, …)</td>
<td>∫₀ᵗ h(u) du (numerical)</td>
</tr><tr class="odd"><td><code>surv()</code></td>
<td>S(t, par, …)</td>
<td>exp(-H(t))</td>
</tr><tr class="even"><td><code>cdf()</code></td>
<td>F(t, par, …)</td>
<td>1 - S(t)</td>
</tr><tr class="odd"><td><code><a href="https://rdrr.io/r/grDevices/pdf.html" class="external-link">pdf()</a></code></td>
<td>f(t, par, …)</td>
<td>h(t) × S(t)</td>
</tr><tr class="even"><td><code>inv_cdf()</code></td>
<td>t given F(t)</td>
<td>Uses <code><a href="https://rdrr.io/r/stats/uniroot.html" class="external-link">uniroot()</a></code>
</td>
</tr><tr class="odd"><td><code>sampler()</code></td>
<td>Generates samples</td>
<td>Inverse CDF sampling</td>
</tr><tr class="even"><td><code>params()</code></td>
<td>Resolved parameters</td>
<td>Handles NA/NULL defaults</td>
</tr></tbody></table></div>
<div class="section level3">
<h3 id="likelihood-model-interface">Likelihood Model Interface<a class="anchor" aria-label="anchor" href="#likelihood-model-interface"></a></h3>
<p>The <code>dfr_dist</code> class implements <code>likelihood_model</code> from the likelihood.model package:</p>
<table class="table"><colgroup><col width="33%"><col width="37%"><col width="29%"></colgroup><thead><tr class="header"><th>Method</th>
<th>Returns</th>
<th>Usage</th>
</tr></thead><tbody><tr class="odd"><td><code><a href="https://queelius.github.io/likelihood.model/reference/loglik.html" class="external-link">loglik()</a></code></td>
<td>Log-likelihood function</td>
<td><code>ll &lt;- loglik(dist); ll(df, par)</code></td>
</tr><tr class="even"><td><code><a href="https://queelius.github.io/likelihood.model/reference/score.html" class="external-link">score()</a></code></td>
<td>Score function (gradient)</td>
<td>Numerical gradient of loglik</td>
</tr><tr class="odd"><td><code><a href="https://queelius.github.io/likelihood.model/reference/hess_loglik.html" class="external-link">hess_loglik()</a></code></td>
<td>Hessian of log-likelihood</td>
<td>Numerical Hessian</td>
</tr><tr class="even"><td><code><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit()</a></code></td>
<td>MLE solver</td>
<td><code>solver &lt;- fit(dist); solver(df, par)</code></td>
</tr></tbody></table></div>
<div class="section level3">
<h3 id="survival-data-conventions">Survival Data Conventions<a class="anchor" aria-label="anchor" href="#survival-data-conventions"></a></h3>
<p>Data frames passed to likelihood methods use: - <code>t</code> column (or <code>ob_col</code>): Observation times - <code>delta</code> column (or <code>delta_col</code>): Event indicators - <code>1</code> = exact observation (failure) - <code>0</code> = right-censored (survived past time t)</p>
<p>Log-likelihood contributions: - Exact: log L_i = log h(t_i) - H(t_i) - Censored: log L_i = -H(t_i)</p>
</div>
<div class="section level3">
<h3 id="numerical-methods">Numerical Methods<a class="anchor" aria-label="anchor" href="#numerical-methods"></a></h3>
<p><strong>Cumulative hazard</strong> uses <code><a href="https://rdrr.io/r/stats/integrate.html" class="external-link">stats::integrate()</a></code> with defaults: - subdivisions = 1000L, abs_tol = 1e-3 (overridable)</p>
<p><strong>Sampling</strong> uses iterative rejection: 1. Start at t = 0, sample from Exp(rate(t, par)) 2. Accept if runif(1) ≤ S(t, par), else increment t by eps</p>
</div>
</div>
<div class="section level2">
<h2 id="package-ecosystem-integration">Package Ecosystem Integration<a class="anchor" aria-label="anchor" href="#package-ecosystem-integration"></a></h2>
<p>This package is designed to work with a family of related packages:</p>
<pre><code>algebraic.dist          # Generic distribution interface (imported)
    ↓
dfr.dist               # This package - DFR distributions
    ↓
likelihood.model       # Likelihood model interface (dfr_dist satisfies this)
    ↓
algebraic.mle          # MLE algebra for hypothesis testing, model selection
    ↓
numerical.mle          # Optimization: gradient ascent, Newton-Raphson, etc.</code></pre>
<div class="section level3">
<h3 id="usage-with-mle">Usage with MLE<a class="anchor" aria-label="anchor" href="#usage-with-mle"></a></h3>
<p>The <code>dfr_dist</code> object satisfies the <code>likelihood_model</code> interface, enabling:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Fit DFR distribution to data using algebraic.mle</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/queelius/algebraic.mle" class="external-link">algebraic.mle</a></span><span class="op">)</span></span>
<span><span class="va">mle_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://queelius.github.io/algebraic.mle/reference/mle.html" class="external-link">mle</a></span><span class="op">(</span><span class="va">dfr_model</span>, <span class="va">data</span>, <span class="va">start_params</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="series-system-packages">Series System Packages<a class="anchor" aria-label="anchor" href="#series-system-packages"></a></h3>
<p>Two packages handle <strong>series systems</strong> (systems that fail when any component fails) with <strong>masked failure data</strong> (where the causing component is uncertain):</p>
<ul><li><p><strong>likelihood.model.series.md</strong>: Series system likelihood models with masked component cause data. Currently implements exponential and Weibull components. Its README explicitly mentions dfr_dist as a future integration for general series systems with arbitrary component hazard functions.</p></li>
<li><p><strong>mdrelax</strong>: Relaxed masking conditions for series systems (Weibull/exponential).</p></li>
</ul><p><strong>Integration potential</strong>: dfr_dist could serve as a component distribution engine for series systems, enabling time-dependent and covariate-dependent component hazards beyond the current exponential/Weibull implementations. The architectural foundation exists in likelihood.model.series.md’s <code>utils.R</code> (<code><a href="reference/cum_haz.html">cum_haz()</a></code>, <code>qcomp()</code>, <code>rcomp()</code> for arbitrary hazard functions).</p>
</div>
<div class="section level3">
<h3 id="core-packages">Core Packages<a class="anchor" aria-label="anchor" href="#core-packages"></a></h3>
<ul><li>
<strong>algebraic.dist</strong>: Provides generics (hazard, cdf, pdf, surv, etc.)</li>
<li>
<strong>likelihood.model</strong>: Defines likelihood interface (loglik, score, hess_loglik)</li>
<li>
<strong>algebraic.mle</strong>: MLE algebra for inference</li>
<li>
<strong>numerical.mle</strong>: Numerical optimization methods</li>
<li>
<strong>md.tools</strong>: Masked data utilities (Boolean matrix encoding/decoding)</li>
</ul></div>
</div>
<div class="section level2">
<h2 id="file-structure">File Structure<a class="anchor" aria-label="anchor" href="#file-structure"></a></h2>
<ul><li>
<code>R/dfr_dist.R</code>: Main S3 class and all methods (~340 lines)</li>
<li>
<code>R/generic_functions.R</code>: Generic <code><a href="reference/cum_haz.html">cum_haz()</a></code> declaration</li>
<li>
<code>R/utils.R</code>: Helper <code>get_params()</code> for parameter resolution</li>
<li>
<code>R/reexports.R</code>: Re-exports from likelihood.model (loglik, score, etc.)</li>
<li>
<code>tests/testthat/test-likelihood_model.R</code>: Comprehensive tests for likelihood interface</li>
<li>
<code>vignettes/failure_rate.Rmd</code>: Main tutorial</li>
</ul></div>
<div class="section level2">
<h2 id="common-pitfalls">Common Pitfalls<a class="anchor" aria-label="anchor" href="#common-pitfalls"></a></h2>
<ol style="list-style-type: decimal"><li>
<strong>Parameter handling</strong>: Always use <code>params(x, par)</code> to handle NA/NULL correctly</li>
<li>
<strong>Integration warnings</strong>: Cumulative hazard uses numerical integration - check for convergence</li>
<li>
<strong>Sampling efficiency</strong>: Rejection sampler can be slow for complex rate functions</li>
<li>
<strong>Closure pattern</strong>: Remember methods return functions, not values directly</li>
</ol></div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Alexander Towell.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

